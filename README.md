# vexa-ai

## تنظیم و استفاده از GPT

برای فعال‌سازی دستیار GPT داخل ربات تلگرام متغیرهای محیطی زیر را مقداردهی کنید:

- `GPT_API` یا `GPT_API_KEY` یا `OPENAI_API_KEY` — کلید دسترسی به سرویس GPT (الزامی).
- `GPT_MODE` — نوع سرویس GPT؛ مقدار `assistant` از OpenAI Assistants/Responses استفاده می‌کند (پیش‌فرض `chat`).
- `GPT_API_URL` — آدرس سرویس چت؛ برای حالت `assistant` به‌صورت پیش‌فرض `https://api.openai.com/v1/responses` است.
- `GPT_MODEL` — نام مدل، پیش‌فرض `gpt-4o-mini`.
- `GPT_API_TIMEOUT` — زمان انتظار درخواست بر حسب ثانیه، پیش‌فرض `45`.
- `GPT_API_KEY_HEADER` و `GPT_API_KEY_PREFIX` — در صورت نیاز به هدر سفارشی برای کلید.
- `GPT_SYSTEM_PROMPT` — پیام سیستمی برای شروع هر مکالمه (پیش‌فرض: «You are Vexa GPT-5…»).
- `GPT_HISTORY_LIMIT` — تعداد پیام‌های اخیر که در هر پاسخ به GPT ارسال می‌شود (پیش‌فرض `6`).
- `GPT_TEMPERATURE` — میزان خلاقیت پاسخ‌ها (۰ تا ۲، پیش‌فرض `0.7`).
- `GPT_TOP_P` — مقدار `top_p` برای نمونه‌گیری هسته‌ای (۰ تا ۱، پیش‌فرض `1`).
- `GPT_MAX_TOKENS` — سقف توکن برای هر پاسخ (۰ یعنی بدون محدودیت جداگانه).
- `GPT_ASSISTANT_ID` — در صورت استفاده از Assistants API می‌توانید شناسه دستیار از پیش ساخته‌شده را وارد کنید (اختیاری). در صورت تنظیم نشدن این متغیر، مقدار `ASSISTANT_ID` (در Secrets) یا `OPENAI_ASSISTANT_ID` نیز به‌صورت خودکار خوانده می‌شود.

در صورتی که بخواهید ربات از OpenAI Assistant/Responses استفاده کند، کافی است متغیر `GPT_MODE=assistant` را تنظیم کنید. در این حالت، پیام‌ها همانند قبل از تاریخچه محلی ساخته شده و به اندپوینت جدید (`/v1/responses`) ارسال می‌شوند و در صورت وجود `GPT_ASSISTANT_ID` همان دستیار از پیش ساخته‌شده اجرا خواهد شد.

## امکانات ربات

- دستور `/gpt` برای شروع گفت‌وگوی مستقیم با GPT در همان چت تلگرام. با دستور `/endgpt` می‌توانید مکالمه را پایان دهید و دکمه «شروع چت جدید ♻️» تاریخچه را پاک می‌کند.
- در منوی اصلی، دکمه GPT شما را به گفت‌وگوی درون ربات هدایت می‌کند.
- دستور `/api` کلید اختصاصی و توضیحات استفاده از API جدید را نمایش می‌دهد تا بتوانید سریعاً اعتبارسنجی را در پروژه‌ی خود پیاده کنید.

پس از مقداردهی متغیرها، ربات آماده است تا پیام‌های کاربران را به سرویس GPT ارسال کرده و پاسخ را داخل تلگرام نمایش دهد.

## API جدید تحت FastAPI (`/api`)

برای استفاده از API جدید که با FastAPI پیاده‌سازی شده است، مراحل زیر را انجام دهید:

1. **نصب پیش‌نیازها:**
   ```bash
   pip install -r requirements.txt
   ```
2. **تنظیم متغیرهای محیطی (در صورت نیاز):**
    - `API_KEY_ENCRYPTION_SECRET` — رشته‌ای طولانی و تصادفی جهت رمزنگاری امن کلیدها (اختیاری؛ در صورت عدم تنظیم، فایل امن `api_key_secret.key` کنار دیتابیس ساخته می‌شود).
2. **تنظیم متغیرهای محیطی الزامی:**
   - `API_KEY_ENCRYPTION_SECRET` — رشته‌ای طولانی و تصادفی جهت رمزنگاری امن کلیدها (الزامی).
   - `ADMIN_API_KEY` — کلید ادمین برای مدیریت کاربران از طریق اندپوینت‌های مدیریتی (الزامی برای استفاده از پنل ادمین).
   - `API_KEY_HEADER_NAME` — نام هدر برای احراز هویت کلاینت‌ها (پیش‌فرض `X-API-Key`).
   - `API_CREDIT_COST` — تعداد کردیت مصرفی به‌ازای هر درخواست معتبر (پیش‌فرض `1`).
3. **اجرای سرور:**
   ```bash
   uvicorn api_app:app --host 0.0.0.0 --port 8000
   ```

### نحوه کارکرد

- هنگام ساخت کاربر جدید، یک API Key یکتا برای او تولید و به‌شکل رمزنگاری شده در دیتابیس ذخیره می‌شود.
- همه‌ی درخواست‌های ورودی باید هدر `X-API-Key` (یا نام تعیین‌شده) را داشته باشند؛ در غیر این صورت خطای `401` بازگردانده می‌شود.
- در صورتی که کلید نامعتبر یا revoke شده باشد، پاسخ `401` دریافت می‌شود.
- بعد از احراز هویت موفق، به‌ازای هر درخواست به اندازه‌ی `API_CREDIT_COST` از کردیت کاربر کاسته می‌شود. کمبود کردیت منجر به خطای `402 Payment Required` خواهد شد.

### اندپوینت‌های کلاینت

- `GET /api/ping` — تست سلامت و مشاهده باقیمانده کردیت.
- `POST /api/echo` — دریافت بدنه‌ی ارسال‌شده همراه با اطلاعات کاربر.

### اندپوینت‌های ادمین (`X-Admin-API-Key`)

- `GET /api/admin/users/{user_id}/api-key?reveal=true` — مشاهده یا بازیابی کلید کاربر.
- `POST /api/admin/users/{user_id}/api-key/regenerate` — تولید کلید جدید و ابطال کلید قبلی.
- `POST /api/admin/users/{user_id}/api-key/revoke` — مسدودسازی کلید کاربر.
- `POST /api/admin/users/{user_id}/api-key/issue` — صدور کلید در صورت نبود یا ابطال قبلی.

سند تعاملی (Swagger) نیز در مسیر `/api/docs` در دسترس است.
